<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ringtone Widget</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    label {
      margin-right: 10px;
    }
    select {
      padding: 4px;
    }
    button {
      margin-left: 10px;
      padding: 4px 10px;
    }
  </style>
</head>
<body>
  <label for="outputSelect">ðŸŽ§ Secondary Ringtone Output:</label>
  <select id="outputSelect"></select>
  <button id="testBtn">ðŸŽµ Test Ringtone</button>

  <script>
    let audio = new Audio('https://desktop.wxcc-us1.cisco.com/sounds/ringtone.mp3');
    let currentSinkId = '';
    audio.loop = true;

    async function loadAudioDevices() {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const outputSelect = document.getElementById('outputSelect');
      outputSelect.innerHTML = '';

      const speakers = devices.filter(d => d.kind === 'audiooutput');
      speakers.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `Output (${device.deviceId})`;
        outputSelect.appendChild(option);
      });

      if (speakers.length > 0) {
        currentSinkId = speakers[0].deviceId;
      }

      outputSelect.addEventListener('change', () => {
        currentSinkId = outputSelect.value;
        if (typeof audio.setSinkId === 'function') {
          audio.setSinkId(currentSinkId).catch(err => {
            console.warn('Failed to set sinkId:', err);
          });
        }
      });
    }

    function playRingtone() {
      if (typeof audio.setSinkId === 'function' && currentSinkId) {
        audio.setSinkId(currentSinkId).catch(console.warn);
      }
      audio.play().catch(console.warn);
    }

    function stopRingtone() {
      audio.pause();
      audio.currentTime = 0;
    }

    document.getElementById('testBtn').addEventListener('click', () => {
      playRingtone();
      setTimeout(stopRingtone, 3000);
    });

    // Optional: Bind to actual Webex event (_dtcc)
    function bindWebexEvents() {
      if (!window._dtcc) {
        console.log('[Ringtone Widget] _dtcc not available yet.');
        return;
      }

      window._dtcc.subscribe('TASK', task => {
        const event = task.eventType;
        console.log('[Ringtone Widget] Webex Event:', event);

        if (event === 'NEW') {
          playRingtone();
        } else if (event === 'ACCEPTED' || event === 'ENDED') {
          stopRingtone();
        }
      });
    }

    // Re-check for _dtcc every second (if needed)
    const checkInterval = setInterval(() => {
      if (window._dtcc) {
        clearInterval(checkInterval);
        bindWebexEvents();
      }
    }, 1000);

    loadAudioDevices();
  </script>
</body>
</html>
