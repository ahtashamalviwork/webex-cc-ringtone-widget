<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ringtone Widget</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    label {
      margin-right: 10px;
    }
    select {
      padding: 4px;
    }
    button {
      margin-left: 10px;
      padding: 4px 10px;
    }
  </style>
</head>
<body>
  <label for="outputSelect">ðŸŽ§ Secondary Ringtone Output:</label>
  <select id="outputSelect"></select>
  <button id="testBtn">ðŸŽµ Test Ringtone</button>

  <script>
  let audio = new Audio('https://desktop.wxcc-us1.cisco.com/sounds/ringtone.mp3');
  let currentSinkId = '';
  audio.loop = true;

  async function loadAudioDevices() {
    try {
      // Ask permission
      await navigator.mediaDevices.getUserMedia({ audio: true });

      const devices = await navigator.mediaDevices.enumerateDevices();
      const outputSelect = document.getElementById('outputSelect');
      outputSelect.innerHTML = '';

      const speakers = devices.filter(d => d.kind === 'audiooutput');
      if (speakers.length === 0) {
        const opt = document.createElement('option');
        opt.text = 'No audio outputs';
        outputSelect.appendChild(opt);
        return;
      }

      speakers.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `Output (${device.deviceId})`;
        outputSelect.appendChild(option);
      });

      currentSinkId = outputSelect.value;

      outputSelect.addEventListener('change', () => {
        currentSinkId = outputSelect.value;
        if (typeof audio.setSinkId === 'function') {
          audio.setSinkId(currentSinkId).catch(console.warn);
        }
      });

    } catch (err) {
      console.error('Permission denied or error:', err);
      alert("Microphone permission is required to list audio devices.");
    }
  }

  function playRingtone() {
    if (typeof audio.setSinkId === 'function' && currentSinkId) {
      audio.setSinkId(currentSinkId).catch(console.warn);
    }
    audio.play().catch(console.warn);
  }

  function stopRingtone() {
    audio.pause();
    audio.currentTime = 0;
  }

  document.getElementById('testBtn').addEventListener('click', () => {
    playRingtone();
    setTimeout(stopRingtone, 3000);
  });

  // Run only on interaction
  document.body.addEventListener('click', () => {
    loadAudioDevices();
  }, { once: true });
</script>
</body>
</html>
