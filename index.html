<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Webex CC Ringtone Widget</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      font-size: 12px;
      padding: 8px;
      background-color: #f4f4f4;
    }

    #widget {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    select, button {
      font-size: 12px;
      padding: 4px 6px;
    }
  </style>
</head>
<body>
  <div id="widget">
    <label for="output">ðŸŽ§ Secondary Ringtone Output:</label>
    <select id="output"></select>
    <button id="testBtn">ðŸ”ˆ Test Ringtone</button>
  </div>

  <script>
    const select = document.getElementById('output');
    const testBtn = document.getElementById('testBtn');

    const audio = new Audio('https://desktop.wxcc-us1.cisco.com/sounds/ringtone.mp3');
    audio.loop = true;

    let selectedDeviceId = null;

    async function loadAudioDevices() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const outputs = devices.filter(d => d.kind === 'audiooutput');
        select.innerHTML = '';

        outputs.forEach(device => {
          const opt = document.createElement('option');
          opt.value = device.deviceId;
          opt.text = device.label || `Output (${device.deviceId})`;
          select.appendChild(opt);
        });

        const saved = localStorage.getItem('ringDeviceId');
        if (saved && outputs.some(d => d.deviceId === saved)) {
          select.value = saved;
          selectedDeviceId = saved;
        } else if (outputs.length > 0) {
          selectedDeviceId = outputs[0].deviceId;
          select.value = selectedDeviceId;
        }
      } catch (e) {
        console.error('[Widget] Failed to load devices:', e);
      }
    }

    select.addEventListener('change', () => {
      selectedDeviceId = select.value;
      localStorage.setItem('ringDeviceId', selectedDeviceId);
    });

    async function setOutput() {
      if (typeof audio.setSinkId === 'function' && selectedDeviceId) {
        try {
          await audio.setSinkId(selectedDeviceId);
        } catch (err) {
          console.warn('[Widget] setSinkId error:', err);
        }
      }
    }

    async function playRingtone() {
      await setOutput();
      try {
        await audio.play();
      } catch (e) {
        console.warn('[Widget] audio.play error:', e);
      }
    }

    function stopRingtone() {
      audio.pause();
      audio.currentTime = 0;
    }

    testBtn.addEventListener('click', async () => {
      await playRingtone();
      setTimeout(stopRingtone, 4000);
    });

    loadAudioDevices();
  </script>
</body>
</html>
